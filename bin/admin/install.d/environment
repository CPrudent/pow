#!/bin/bash

    #--------------------------------------------------------------------------
    # synopsis
    #--
    # build POW's environment

source $POW_DIR_ROOT/lib/libenv.sh || exit ${ERROR_CODE:-3}

is_user_root &&

# deal w/ log directory
{
    [ ! -d "$POW_DIR_LOG" ] && {
        mkdir -p $POW_DIR_LOG || {
            echo "souci cr√©ation dossier $POW_DIR_LOG"
            false
        }
    }
} &&

{
    get_tmp_file --tmpfile _tmpfile &&
    cat <<-EOC > $_tmpfile

    ### add POW environment
    set -o allexport &&
    source $POW_DIR_ROOT/lib/libenv.sh &&
    export BASH_ENV=$POW_DIR_ROOT/lib/bashenv.sh &&
    set +o allexport
    ###
    EOC

    _dir_home=$(getent passwd $POW_USER | cut --delimiter : --field 6)
    _group=$(getent passwd $POW_USER | cut --delimiter : --field 4)
    # TODO: field #7=shell
    [ ! -f "$_dir_home/.bashrc" ] && {
        touch "$_dir_home/.bashrc" && chown $POW_USER:$_group "$_dir_home/.bashrc"
    }
    grep '### add POW environment' "$_dir_home/.bashrc" || cat $_tmpfile >> "$_dir_home/.bashrc"
}
